# Outpost Public Release Procedure

> How to publish updates from private repo (rgsuarez/outpost) to public repo (zeroechelon/outpost)

## Overview

```
rgsuarez/outpost (private, development)
         │
         ▼
    scrub-and-publish.sh
         │
         ├── Fetch source files
         ├── Apply scrubbing (remove hardcoded values)
         ├── Generate public-only files (README, LICENSE)
         └── Push to public repo
         │
         ▼
zeroechelon/outpost (public, release)
```

## Prerequisites

1. **GitHub PATs configured:**
   - `GITHUB_TOKEN` — rgsuarez PAT (private repo read)
   - `ZEROECHELON_TOKEN` — zeroechelon PAT (public repo write)

2. **Source files exist in private repo:**
   - All scripts in `scripts/`
   - All docs in `docs/`
   - No session-journals or credentials

## Files Published

### Copied and Scrubbed

| Source (private) | Destination (public) | Scrubbing Applied |
|------------------|---------------------|-------------------|
| scripts/dispatch-unified.sh | scripts/dispatch-unified.sh | Path generalization |
| scripts/dispatch.sh | scripts/dispatch.sh | Path generalization |
| scripts/dispatch-codex.sh | scripts/dispatch-codex.sh | Path generalization |
| scripts/dispatch-gemini.sh | scripts/dispatch-gemini.sh | Path generalization |
| scripts/dispatch-aider.sh | scripts/dispatch-aider.sh | Path generalization |
| scripts/assemble-context.sh | scripts/assemble-context.sh | Path generalization |
| scripts/scrub-secrets.sh | scripts/scrub-secrets.sh | None |
| scripts/setup-agents.sh | scripts/setup-agents.sh | None |
| scripts/promote-workspace.sh | scripts/promote-workspace.sh | Path generalization |
| scripts/list-runs.sh | scripts/list-runs.sh | Path generalization |
| docs/CONTEXT_INJECTION_SPEC.md | docs/CONTEXT_INJECTION_SPEC.md | None |
| docs/SETUP_SERVER.md | docs/SETUP_SERVER.md | None |
| docs/SETUP_AGENTS.md | docs/SETUP_AGENTS.md | None |

### Generated Fresh

| File | Source |
|------|--------|
| README.md | Generated by script (AI-agent optimized) |
| LICENSE | MIT License template |
| .env.template | Generated by script |
| .gitignore | Generated by script |

### Never Published

- `session-journals/*` — Private session history
- `.env` — Credentials
- `OUTPOST_INTERFACE.md` — Contains SSM instance IDs
- `tools/*` — Internal tooling
- `runs/*`, `repos/*` — Runtime artifacts

## Scrubbing Rules

The following transformations are applied:

| Pattern | Replacement |
|---------|-------------|
| `/home/ubuntu/claude-executor` | `${OUTPOST_DIR:-/opt/outpost}` |
| `rgsuarez` (in URLs) | `${GITHUB_USER}` |
| `mi-0d77bfe39f630bd5c` | Removed |
| `52.44.78.2` | Removed |
| `311493921645` | Removed |
| `535471339422` | Removed |
| `github_pat_*` | Removed |
| `AKIA*` | Removed |
| `sk-ant-*` | Removed |

## Running the Release

### From Claude Session

```bash
# Ensure both PATs are available in user preferences
# Run the scrub-and-publish script

./tools/scrub-and-publish.sh --message "v1.5.1 release"
```

### Dry Run (Preview)

```bash
./tools/scrub-and-publish.sh --dry-run
```

### Manual Override

If the script fails, files can be pushed manually via GitHub API:

```bash
# Fetch from private
curl -s -H "Authorization: token $GITHUB_TOKEN" \
  "https://api.github.com/repos/rgsuarez/outpost/contents/scripts/dispatch.sh" | \
  python3 -c "import json,sys,base64; print(base64.b64decode(json.load(sys.stdin)['content']).decode())" > file.sh

# Apply scrubbing
sed -i 's|/home/ubuntu/claude-executor|${OUTPOST_DIR:-/opt/outpost}|g' file.sh

# Push to public
CONTENT=$(cat file.sh | base64 -w 0)
curl -X PUT -H "Authorization: token $ZEROECHELON_TOKEN" \
  "https://api.github.com/repos/zeroechelon/outpost/contents/scripts/dispatch.sh" \
  -d "{\"message\":\"update\",\"content\":\"$CONTENT\"}"
```

## Verification

After release, verify:

1. Public repo has all expected files
2. No credentials or hardcoded values present
3. README renders correctly
4. Scripts have correct paths (environment variables)

```bash
# Check public repo contents
curl -s "https://api.github.com/repos/zeroechelon/outpost/contents/" | \
  python3 -c "import json,sys; [print(f['name']) for f in json.load(sys.stdin)]"

# Verify no secrets in scripts
curl -s "https://raw.githubusercontent.com/zeroechelon/outpost/main/scripts/dispatch-unified.sh" | \
  grep -E "(github_pat|AKIA|sk-ant|rgsuarez)" && echo "WARNING: Secrets found!" || echo "OK: No secrets"
```

## Rollback

If a bad release is published:

1. Identify the problematic commit in zeroechelon/outpost
2. Revert via GitHub UI or:
   ```bash
   git revert <commit-sha>
   git push
   ```

## Version Tagging

After successful release:

```bash
# Create tag in public repo
curl -X POST -H "Authorization: token $ZEROECHELON_TOKEN" \
  "https://api.github.com/repos/zeroechelon/outpost/git/refs" \
  -d '{"ref":"refs/tags/v1.5.0","sha":"<commit-sha>"}'
```

---

*Last updated: 2026-01-03*
